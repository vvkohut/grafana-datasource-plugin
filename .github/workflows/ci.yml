name: CI Pipeline

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      publish_to_aws:
        description: 'Publish to AWS S3'
        required: true
        default: false
        type: boolean

env:
  NODE_VERSION: '22'
  GO_VERSION: '1.24.4'
  KUBERNETES_CPU_LIMIT: '12'
  KUBERNETES_CPU_REQUEST: '12'
  KUBERNETES_MEMORY_REQUEST: '16Gi'
  KUBERNETES_MEMORY_LIMIT: '16Gi'

jobs:
  prepare-frontend:
    name: Prepare Frontend
    uses: ./.github/workflows/prepare-frontend.yml
    with:
      node_version: ${{ env.NODE_VERSION }}

  build-frontend:
    name: Build Frontend
    uses: ./.github/workflows/build-frontend.yml
    needs: prepare-frontend
    with:
      node_version: ${{ env.NODE_VERSION }}

  test-frontend:
    name: Test Frontend
    uses: ./.github/workflows/test-frontend.yml
    needs: prepare-frontend
    with:
      node_version: ${{ env.NODE_VERSION }}

  build-backend:
    name: Build Backend
    uses: ./.github/workflows/build-backend.yml
    with:
      go_version: ${{ env.GO_VERSION }}

  test-backend:
    name: Test Backend
    uses: ./.github/workflows/test-backend.yml
    if: false
    with:
      go_version: ${{ env.GO_VERSION }}

  package:
    name: Package Plugin
    uses: ./.github/workflows/package.yml
    needs: [build-frontend, build-backend]
    with:
      node_version: ${{ env.NODE_VERSION }}
    secrets:
      grafana_token: ${{ secrets.GRAFANA_ACCESS_POLICY_TOKEN }}

  e2e:
    name: E2E Tests
    uses: ./.github/workflows/e2e.yml
    needs: [package]

  publish-aws:
    name: Publish to AWS S3
    uses: ./.github/workflows/s3_publish.yml
    if: inputs.publish_to_aws
    needs: [package]

  log:
    name: LOG
    runs-on: ubuntu-latest
    needs: [e2e]
    steps:
      - name: Display all outputs as JSON
        run: |
          echo "${{ toJSON(github) }}"
      - name: RUN RELEASE ?
        run: |
          echo "${{ github.event_name == 'pull_request' && github.base_ref == 'main' }}"
      - name: IS DRAFT ?
        run: |
          echo "${{ contains(needs.package.outputs.version, 'dev') }}"

  create-github-release:
    name: Create GitHub Release
    uses: ./.github/workflows/release.yml
    needs: [e2e]
    if: github.event_name == 'pull_request' && github.base_ref == 'main'